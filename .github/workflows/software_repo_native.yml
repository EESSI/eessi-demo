# documentation: https://help.github.com/en/articles/workflow-syntax-for-github-actions
name: Tests for EESSI software repo (native access)
on: [push, pull_request, workflow_dispatch]
# Declare default permissions as read only.
permissions: read-all
jobs:
  software_repo_native:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        EESSI_DEMO:
        - Bioconductor
        - GROMACS
        - OpenFOAM
        - TensorFlow
        - ESPResSo
        - PyTorch
        - QuantumESPRESSO
        EESSI_VERSION:
        - "2023.06"
    steps:
        - name: Check out software-layer repository
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
          with:
            persist-credentials: false

        - name: Mount EESSI CernVM-FS software repository
          uses: eessi/github-action-eessi@v3
          with:
            eessi_stack_version: '2023.06'

        - name: Run demo
          run: |
              source /cvmfs/software.eessi.io/versions/${{matrix.EESSI_VERSION}}/init/bash
              cd ${{matrix.EESSI_DEMO}}
              pwd
              if [ {{matrix.EESSI_DEMO}} = OpenFOAM ]; then
                  #export X=2 Y=1 Z=1
                  sed -i 's/BLOCKMESH_DIMENSIONS="100 40 40"/BLOCKMESH_DIMENSIONS="50 20 20"/g' bike_OpenFOAM_v11.sh
                  sed -i 's/endTime -set 200/endTime -set 20/g' bike_OpenFOAM_v11.sh
                  sed -i 's/maxGlobalCells -set 8000000/maxGlobalCells -set 1000000/g' bike_OpenFOAM_v11.sh
                  sudo swapoff -a
                  sudo fallocate -l 24G /swapfile
                  sudo chmod 600 /swapfile
                  sudo mkswap /swapfile
                  sudo swapon /swapfile
                  sudo swapon --show
              fi
              ./run.sh
